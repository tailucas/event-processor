#!/usr/bin/python
import os
import sys

from ConfigParser import SafeConfigParser, InterpolationMissingOptionError, NoOptionError


FAKE_SECTION = 'FAKESECTION'


class FakeSecHead(object):
    def __init__(self, fp):
        self.fp = fp
        self.sechead = '[{}]\n'.format(FAKE_SECTION)

    def readline(self):
        if self.sechead:
            try:
                return self.sechead
            finally:
                self.sechead = None
        else:
            return self.fp.readline()


def load_config(fp):
    cfg = SafeConfigParser()
    cfg.optionxform = str
    cfg.readfp(FakeSecHead(fp))
    return cfg


def err(msg, code=1):
    sys.stderr.write(msg + '\n')
    exit(code)


if __name__ == "__main__":
    overlay_config = None
    if len(sys.argv) == 2 and os.path.isfile(sys.argv[1]):
        with open(sys.argv[1], 'r') as fp:
            overlay_config = load_config(fp)
    config = load_config(sys.stdin)
    sections = dict()
    try:
        for section in config.sections():
            # we don't use config.items() here to avoid emitting the defaults too
            for option in config.options(section=section):
                value = None
                if overlay_config and overlay_config.has_section(section):
                    value = overlay_config.get(section=section, option=option, vars=os.environ)
                if value is None:
                    value = config.get(section=section, option=option, vars=os.environ)
                # store this now
                if section not in sections:
                    sections[section] = dict()
                if option not in sections[section]:
                    sections[section][option] = dict()
                sections[section][option] = value
        if overlay_config:
            # now supplement the overlay options
            for section in overlay_config.sections():
                # we don't use config.items() here to avoid emitting the defaults too
                for option in overlay_config.options(section=section):
                    value = overlay_config.get(section=section, option=option, vars=os.environ)
                    if section not in sections:
                        sections[section] = dict()
                    if option not in sections[section]:
                        sections[section][option] = dict()
                    sections[section][option] = value
    except InterpolationMissingOptionError as e:
        err(e.message)
    except NoOptionError as e:
        section_name = "section: '{}'."
        if section == FAKE_SECTION:
            section_name = "default section."
        err("No option '{}' in {}".format(option, section_name), 2)
    # now output, starting with the default section
    if FAKE_SECTION in sections:
        for option, value in sections[FAKE_SECTION].items():
            print '{key}={value}'.format(key=option, value=value)
        del sections[FAKE_SECTION]
    # now do each section
    for section in sections:
        print '[{section}]'.format(section=section)
        for option, value in sections[section].items():
            print '{key}={value}'.format(key=option, value=value)